// ---------- Generators & Datasource ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum RoomStatus {
  AVAILABLE
  UNAVAILABLE
}

enum BookingStatus {
  // ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á) ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  AWAITING_ATTENDEE_CONFIRM // ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
  AWAITING_ADMIN_APPROVAL // ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß/‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
  APPROVED
  REJECTED
  CANCELLED
}

enum InviteStatus {
  INVITED
  ACCEPTED
  DECLINED
}

enum NoteQueueStatus {
  INVITED
  ACCEPTED
  DECLINED
  REPLACED
}

enum ServiceCategory {
  IT
  HOUSEKEEPING
  NOTETAKING
}

enum ServiceStatus {
  PENDING // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß
  IN_PROGRESS // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
  CONFIRMED // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
  COMPLETED // ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏à‡∏ö
  REJECTED
}

/**
 * ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° enum ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Notification
 */
enum NotifType {
  INVITE
  APPROVED
  REJECTED
  CANCELED
  RESCHEDULED
  ISSUE_CREATED
}

enum RefType {
  BOOKING
  INVITE
  ISSUE
}

// ---------- Master Data ----------
model Department {
  id        Int        @id @default(autoincrement())
  name      String     @unique // ‡πÄ‡∏ä‡πà‡∏ô IT, Housekeeping, NoteTaking
  positions Position[]
  services  Service[]
}

model Position {
  id            Int         @id @default(autoincrement())
  name          String      @unique // ‡πÄ‡∏ä‡πà‡∏ô Admin, Manager, Staff, NoteTaker
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á/‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
  isAdmin       Boolean     @default(false)
  isNoteManager Boolean     @default(false)
  isNoteTaker   Boolean     @default(false)
  description   String?
  departmentId  Int?
  department    Department? @relation(fields: [departmentId], references: [id])

  users    User[]
  neededBy BookingRequiredPosition[]
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  fullName     String
  email        String?  @unique
  positionId   Int
  position     Position @relation(fields: [positionId], references: [id])
  createdAt    DateTime @default(now())

  // ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á
  bookingsBooked Booking[] @relation("BookedBy")

  // ‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Üí ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)
  bookingInvites BookingInvite[]

  // ‡∏ñ‡∏π‡∏Å assign ‡πÉ‡∏´‡πâ‡∏à‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
  noteTakerAssigns BookingNoteTaker[]

  // ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå Notification (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
  notifications Notification[] @relation("UserNotifications")

  // üîß FIX: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô one-to-one (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ NoteTakerQueue.userId ‡πÄ‡∏õ‡πá‡∏ô @unique)
  noteTakerQueue NoteTakerQueue?

  // ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå NoteTakerLeave
  noteTakerLeaves NoteTakerLeave[] @relation("UserNoteTakerLeaves")
}

// ---------- Rooms & Bookings ----------
model MeetingRoom {
  id       Int        @id @default(autoincrement())
  roomName String     @unique
  capacity Int // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 30, 50, 100
  status   RoomStatus @default(AVAILABLE)

  bookings Booking[]
}

model Booking {
  id     Int         @id @default(autoincrement())
  roomId Int
  room   MeetingRoom @relation(fields: [roomId], references: [id])

  bookedById Int
  bookedBy   User @relation("BookedBy", fields: [bookedById], references: [id])

  startTime DateTime
  endTime   DateTime
  status    BookingStatus @default(AWAITING_ATTENDEE_CONFIRM)

  purpose   String? // ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  createdAt DateTime @default(now())

  // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
  requiredPositions BookingRequiredPosition[]

  // ‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
  invites BookingInvite[]

  // ‡∏ú‡∏π‡πâ‡∏à‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2 ‡∏Ñ‡∏ô/‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
  noteTakers BookingNoteTaker[]

  // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)
  services BookingService[]
}

model BookingRequiredPosition {
  id         Int @id @default(autoincrement())
  bookingId  Int
  positionId Int

  booking  Booking  @relation(fields: [bookingId], references: [id])
  position Position @relation(fields: [positionId], references: [id])

  @@index([bookingId])
  @@index([positionId])
}

model BookingInvite {
  id          Int          @id @default(autoincrement())
  bookingId   Int
  userId      Int
  status      InviteStatus @default(INVITED)
  respondedAt DateTime?

  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([bookingId, userId])
  @@index([userId])
  @@index([bookingId, status])
}

model BookingNoteTaker {
  id        Int             @id @default(autoincrement())
  bookingId Int
  userId    Int
  roleIndex Int // 1,2 = ‡∏´‡∏•‡∏±‡∏Å ; 3,4 = ‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ)
  status    NoteQueueStatus @default(INVITED)

  booking Booking @relation(fields: [bookingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([bookingId, userId])
  @@index([userId])
  @@index([bookingId, status])
}

model NoteTakerQueue {
  id       Int     @id @default(autoincrement())
  userId   Int     @unique
  user     User    @relation(fields: [userId], references: [id])
  orderNo  Int
  isActive Boolean @default(true)

  @@index([isActive, orderNo])
}

// ---------- Services / Options ----------
model Service {
  id           Int             @id @default(autoincrement())
  name         String          @unique // ‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå, ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á, ‡∏Å‡∏≤‡πÅ‡∏ü/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°, ‡∏à‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
  category     ServiceCategory
  departmentId Int? // ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÄ‡∏ä‡πà‡∏ô IT, Housekeeping, NoteTaking
  department   Department?     @relation(fields: [departmentId], references: [id])

  requiresApproval Boolean @default(false) // ‡πÄ‡∏ä‡πà‡∏ô IT ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á confirm ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå

  bookingUsages BookingService[]
}

model BookingService {
  id        Int           @id @default(autoincrement())
  bookingId Int
  serviceId Int
  quantity  Int? // ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡πÅ‡∏ü‡∏Å‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏ß
  status    ServiceStatus @default(PENDING)
  // ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ/‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î

  booking Booking @relation(fields: [bookingId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  @@index([bookingId])
  @@index([serviceId, status])
}

// ---------- Notifications (‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏ö) ----------
model Notification {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation("UserNotifications", fields: [userId], references: [id])

  // ‡∏ä‡∏ô‡∏¥‡∏î/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠ UI ‡πÅ‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
  type    NotifType
  title   String // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
  message String

  // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏µ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏ó‡∏≥ FK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô)
  refType RefType?
  refId   Int? // ‡πÉ‡∏ä‡πâ Int ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö id ‡∏Ç‡∏≠‡∏á Booking/Invite/Issue ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏µ‡∏°‡∏≤

  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?

  // ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö list ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î + ‡∏ô‡∏±‡∏ö unread ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
  @@index([userId, isRead, createdAt])
}

model NoteTakerLeave {
  id        Int      @id @default(autoincrement())
  userId    Int
  date      DateTime // daily leave (00:00:00 ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô)
  reason    String?
  createdAt DateTime @default(now())

  user User @relation("UserNoteTakerLeaves", fields: [userId], references: [id])

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô notetakers.ts: atDate() ‡∏à‡∏∞ normalize ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 00:00 ‚Üí ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏û‡∏≠‡∏î‡∏µ
  @@unique([userId, date])
  @@index([userId, date])
}
